{% extends "doctor/layout.html" %}

{% block content %}
<div class="container-fluid">

  <h2>âš™ï¸ Konfiguracja</h2>
  <br>

  <!-- ===== GOOGLE CONNECT ===== -->
  <div style="margin-bottom:20px;">
    <a href="{{ url_for('doctor.google_connect') }}"
       class="btn btn-success">
       ğŸ”— PoÅ‚Ä…cz Google Calendar
    </a>

    {% if current_user.google_connected %}
      <span class="label label-success" style="margin-left:10px;">
        PoÅ‚Ä…czono
      </span>
    {% endif %}
  </div>

  <!-- ===============================
       OGÃ“LNE USTAWIENIA
       =============================== -->
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Klucz</th>
        <th>Opis</th>
        <th>WartoÅ›Ä‡</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
    {% for s in settings %}
      {% if not s.key.startswith("google_")
            and not s.key.startswith("smsapi_")
            and s.key not in [
              "sms_enabled",
              "sms_reminders_enabled",
              "sms_default_country_code",
              "sms_dry_run"
            ] %}

      {% if s.key == "calendar_visible_days" %}
      <tr>
        <form method="post"
              action="{{ url_for('doctor.update_setting', key=s.key) }}">
          <td><code>{{ s.key }}</code></td>
          <td>{{ s.description }}</td>
          <td>
            {% set selected = s.value.split(",") %}
            {% for d,label in [
              ('mon','Pn'),('tue','Wt'),('wed','Åšr'),
              ('thu','Cz'),('fri','Pt'),('sat','So'),('sun','Nd')
            ] %}
              <label style="margin-right:10px;">
                <input type="checkbox"
                       name="days"
                       value="{{ d }}"
                       {% if d in selected %}checked{% endif %}>
                {{ label }}
              </label>
            {% endfor %}
          </td>
          <td>
            <button class="btn btn-xs btn-primary">ğŸ’¾ Zapisz</button>
          </td>
        </form>
      </tr>
      {% else %}
      <tr>
        <form method="post"
              action="{{ url_for('doctor.update_setting', key=s.key) }}">
          <td><code>{{ s.key }}</code></td>
          <td>{{ s.description }}</td>
          <td>
            <input type="text"
                   name="value"
                   class="form-control"
                   value="{{ s.value }}">
          </td>
          <td>
            <button class="btn btn-xs btn-primary">ğŸ’¾ Zapisz</button>
          </td>
        </form>
      </tr>
      {% endif %}
      {% endif %}
    {% endfor %}
    </tbody>
  </table>

  <hr>

  <!-- ===============================
       KONFIGURACJA SMS (SMSAPI)
       =============================== -->
  <h3>ğŸ“¨ SMS (SMSAPI)</h3>
  <br>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Klucz</th>
        <th>Opis</th>
        <th>WartoÅ›Ä‡</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
    {% for s in settings %}
      {% if s.key in [
            "sms_enabled",
            "sms_reminders_enabled",
            "sms_dry_run",
            "sms_default_country_code"
          ] or s.key.startswith("smsapi_") %}
      <tr>
        <form method="post"
              action="{{ url_for('doctor.update_setting', key=s.key) }}">
          <td><code>{{ s.key }}</code></td>
          <td>{{ s.description }}</td>
          <td>

            {% if s.key in ["sms_enabled", "sms_reminders_enabled", "sms_dry_run"] %}
              <input type="hidden" name="value" value="0">
              <label>
                <input type="checkbox"
                       name="value"
                       value="1"
                       {% if s.value == "1" %}checked{% endif %}>
                {% if s.key == "sms_enabled" %}
                  WysyÅ‚ka SMS aktywna
                {% elif s.key == "sms_reminders_enabled" %}
                  Automatyczne przypomnienia SMS (48h)
                {% else %}
                  Tryb testowy (nie wysyÅ‚aj SMS)
                {% endif %}
              </label>

            {% elif s.key == "smsapi_token" %}
              <input type="password"
                     name="value"
                     class="form-control"
                     value="{{ s.value }}">
            {% else %}
              <input type="text"
                     name="value"
                     class="form-control"
                     value="{{ s.value }}">
            {% endif %}

          </td>
          <td>
            <button class="btn btn-xs btn-primary">ğŸ’¾ Zapisz</button>
          </td>
        </form>
      </tr>
      {% endif %}
    {% endfor %}
    </tbody>
  </table>

  <hr>

  <!-- ===============================
       GOOGLE CALENDAR
       =============================== -->
  <h3>ğŸ“… Google Calendar</h3>
  <br>

  <div class="alert alert-warning">
    <strong>Uwaga:</strong><br>
    Odbudowa kalendarza Google usuwa wszystkie wizyty aplikacji
    z Google Calendar i tworzy je ponownie na podstawie bazy danych.
    <br>
    UÅ¼yj tylko w przypadku problemÃ³w z synchronizacjÄ…
    (duplikaty, brakujÄ…ce wizyty, rÄ™czne zmiany w Google).
  </div>

  <button id="btn-rebuild-google"
        onclick="rebuildGoogle()"
        class="btn btn-danger"
        style="margin-left:10px;">
  â™»ï¸ Odbuduj kalendarz Google
  </button>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Klucz</th>
        <th>Opis</th>
        <th>WartoÅ›Ä‡</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
    {% for s in settings %}
      {% if s.key.startswith("google_") %}
      <tr>
        <form method="post"
              action="{{ url_for('doctor.update_setting', key=s.key) }}">
          <td><code>{{ s.key }}</code></td>
          <td>{{ s.description }}</td>
          <td>
            <input type="text"
                   name="value"
                   class="form-control"
                   value="{{ s.value }}"
                   {% if s.key == "google_connected" %}readonly{% endif %}>
          </td>
          <td>
            <button class="btn btn-xs btn-primary">ğŸ’¾ Zapisz</button>
          </td>
        </form>
      </tr>
      {% endif %}
    {% endfor %}
    </tbody>
  </table>

</div>

<script>
let googleActionLock = false;
const COOLDOWN_MS = 60_000; // 1 minuta

function lockButtons(text) {
  googleActionLock = true;

  ["btn-sync-google", "btn-rebuild-google"].forEach(id => {
    const btn = document.getElementById(id);
    if (!btn) return;

    btn.disabled = true;
    btn.dataset.originalText = btn.innerHTML;
    btn.innerHTML = `â³ ${text}`;
  });
}

function unlockButtonsAfterCooldown() {
  setTimeout(() => {
    googleActionLock = false;

    ["btn-sync-google", "btn-rebuild-google"].forEach(id => {
      const btn = document.getElementById(id);
      if (!btn) return;

      btn.disabled = false;
      btn.innerHTML = btn.dataset.originalText;
    });
  }, COOLDOWN_MS);
}

/* ================================
   ğŸ”„ SYNC
   ================================ */
function syncGoogle() {
  if (googleActionLock) {
    alert("â³ Synchronizacja juÅ¼ trwa lub niedawno siÄ™ zakoÅ„czyÅ‚a");
    return;
  }

  if (!confirm("SynchronizowaÄ‡ wizyty z Google Calendar?")) return;

  lockButtons("Synchronizacjaâ€¦");

  fetch("/doctor/google/sync-batch", { method: "POST" })
    .then(r => r.json())
    .then(data => {
      alert(
        `âœ… Synchronizacja zakoÅ„czona\n\n` +
        `Zsynchronizowano: ${data.synced}\n` +
        `PominiÄ™to: ${data.skipped}\n\n` +
        `â³ Przyciski bÄ™dÄ… aktywne za 1 minutÄ™`
      );
    })
    .catch(() => {
      alert("âŒ BÅ‚Ä…d synchronizacji");
    })
    .finally(() => {
      unlockButtonsAfterCooldown();
    });
}

/* ================================
   â™»ï¸ REBUILD
   ================================ */
function rebuildGoogle() {
  if (googleActionLock) {
    alert("â³ Operacja juÅ¼ trwa lub niedawno siÄ™ zakoÅ„czyÅ‚a");
    return;
  }

  if (!confirm(
    "âš ï¸ UWAGA!\n\n" +
    "Ta operacja:\n" +
    "â€¢ usunie wszystkie wizyty aplikacji z Google Calendar\n" +
    "â€¢ utworzy je OD NOWA z bazy danych\n\n" +
    "Czy na pewno chcesz kontynuowaÄ‡?"
  )) return;

  lockButtons("Odbudowaâ€¦");

  fetch("/doctor/google/rebuild", { method: "POST" })
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(data => {
      alert(
        `â™»ï¸ Kalendarz Google odbudowany\n\n` +
        `UsuniÄ™to: ${data.deleted}\n` +
        `Utworzono: ${data.created}\n\n` +
        `â³ Przyciski bÄ™dÄ… aktywne za 1 minutÄ™`
      );
    })
    .catch(err => {
      console.error("REBUILD ERROR:", err);
      alert("âŒ BÅ‚Ä…d odbudowy kalendarza Google");
    })
    .finally(() => {
      unlockButtonsAfterCooldown();
    });
}
</script>


{% endblock %}
