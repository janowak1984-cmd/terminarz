<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Szczeg√≥≈Çy wizyty</title>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">

<style>
body {
    padding: 30px;
}
.section {
    margin-bottom: 40px;
}
.table th {
    background: #f5f5f5;
}
.header-actions {
    margin-bottom: 20px;
}
.message-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 10px;
    border-radius: 6px;
    max-height: 200px;
    overflow: auto;
    font-size: 13px;
}

.message-box pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}
.message-box h1,
.message-box h2,
.message-box h3 {
    margin-top: 0;
    font-size: 16px;
}

.message-box a {
    color: #d73930;
    text-decoration: none;
}

.message-box a:hover {
    text-decoration: underline;
}
.message-box {
    max-height: 180px;
}
</style>
</head>
<body>

<div class="container">

<div class="header-actions">
    <button class="btn btn-default" onclick="window.print()">üñ® Drukuj</button>
    <button class="btn btn-danger" onclick="window.close()">‚úñ Zamknij okno</button>
</div>

<!-- ===================== -->
<!-- SZCZEG√ì≈ÅY WIZYTY -->
<!-- ===================== -->

<div class="section">
    <h3>üìã Szczeg√≥≈Çy wizyty</h3>
   <table class="table table-bordered">

    <tr>
        <th>ID</th>
        <td>{{ appointment.id }}</td>
    </tr>

    <tr>
        <th>Status</th>
        <td>
            {% if appointment.status == "scheduled" %}
                <span class="label label-primary">Zaplanowana</span>
            {% elif appointment.status == "completed" %}
                <span class="label label-success">Zrealizowana</span>
            {% elif appointment.status == "cancelled" %}
                <span class="label label-danger">Anulowana</span>
            {% else %}
                {{ appointment.status }}
            {% endif %}
        </td>
    </tr>

    <tr>
        <th>Typ wizyty</th>
        <td>
            {% if visit_type %}
                {{ visit_type.name }}
            {% else %}
                {{ appointment.visit_type }}
            {% endif %}
        </td>
    </tr>

    <tr>
        <th>Start</th>
        <td>{{ appointment.start.strftime("%d.%m.%Y %H:%M") }}</td>
    </tr>

    <tr>
        <th>Koniec</th>
        <td>{{ appointment.end.strftime("%d.%m.%Y %H:%M") }}</td>
    </tr>

    <tr>
        <th>Czas trwania</th>
        <td>{{ appointment.duration }} min</td>
    </tr>

    <tr>
        <th>Imiƒô</th>
        <td>{{ appointment.patient_first_name }}</td>
    </tr>

    <tr>
        <th>Nazwisko</th>
        <td>{{ appointment.patient_last_name }}</td>
    </tr>

    <tr>
        <th>Telefon</th>
        <td>{{ appointment.patient_phone }}</td>
    </tr>

    <tr>
        <th>Email</th>
        <td>{{ appointment.patient_email or '-' }}</td>
    </tr>

    <tr>
        <th>Utworzona przez</th>
        <td>
            {% if appointment.created_by == "patient" %}
                üë§ Pacjent
            {% elif appointment.created_by == "doctor" %}
                ü©∫ Lekarz
            {% else %}
                {{ appointment.created_by }}
            {% endif %}
        </td>
    </tr>

    <tr>
        <th>Data utworzenia</th>
        <td>{{ appointment.created_at.strftime("%d.%m.%Y %H:%M") }}</td>
    </tr>

    <tr>
        <th>IP klienta</th>
        <td>{{ appointment.client_ip or '-' }}</td>
    </tr>

</table>

</div>

<hr>

<h3>üí≥ Informacje o p≈Çatno≈õci</h3>

{% if latest_payment %}

  <p>
    <strong>Metoda p≈Çatno≈õci:</strong>
    {% if latest_payment.provider == "przelewy24" %}
      üí≥ Przelewy24 (online)
    {% elif latest_payment.provider == "manual_transfer" %}
      üè¶ Przelew tradycyjny
    {% else %}
      üí∞ P≈Çatno≈õƒá w gabinecie
    {% endif %}
  </p>

  <p>
    <strong>Status p≈Çatno≈õci:</strong>
    {% if latest_payment.status == "paid" %}
      <span class="label label-success">Op≈Çacona</span>
    {% elif latest_payment.status == "pending" %}
      <span class="label label-warning">Oczekuje</span>
    {% elif latest_payment.status == "init" %}
      <span class="label label-info">Zainicjowana</span>
    {% elif latest_payment.status == "failed" %}
      <span class="label label-danger">Nieudana</span>
    {% elif latest_payment.status == "cancelled" %}
      <span class="label label-default">Anulowana</span>
    {% else %}
      {{ latest_payment.status }}
    {% endif %}
  </p>

  <p>
    <strong>Kwota:</strong>
    {{ "%.2f"|format(latest_payment.amount / 100) }} {{ latest_payment.currency }}
  </p>

  <p>
    <strong>Data utworzenia:</strong>
    {{ latest_payment.created_at.strftime("%d.%m.%Y %H:%M") }}
  </p>

  {% if latest_payment.paid_at %}
    <p>
      <strong>Data op≈Çacenia:</strong>
       {{ latest_payment.paid_at.strftime("%d.%m.%Y %H:%M") }}
    </p>
  {% endif %}

{% else %}

  <p>
    <strong>Metoda p≈Çatno≈õci:</strong>  üíµ P≈Çatno≈õƒá w gabinecie
  </p>

  <p>
    <strong>Status:</strong>
    {% if appointment.status == "completed" %}
      <span class="label label-success">Zrealizowana</span>
    {% else %}
      <span class="label label-default">Brak p≈Çatno≈õci online</span>
    {% endif %}
  </p>

{% endif %}


<!-- ===================== -->
<!-- SMS -->
<!-- ===================== -->

<div class="section">
    <h3>üì© Historia SMS</h3>

    {% if sms_messages %}
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Typ</th>
                <th>Status</th>
                <th>Telefon</th>
                <th>Tre≈õƒá</th>
                <th>B≈ÇƒÖd</th>
                <th>Utworzono</th>
                <th>Wys≈Çano</th>
            </tr>
        </thead>
        <tbody>
            {% for sms in sms_messages %}
            <tr>
                <td>{{ sms.id }}</td>
                <td>{{ sms.type }}</td>
                <td>
                    {% if sms.status == "sent" %}
                        <span class="label label-success">Wys≈Çany</span>
                    {% elif sms.status == "failed" %}
                        <span class="label label-danger">B≈ÇƒÖd</span>
                    {% elif sms.status == "pending" %}
                        <span class="label label-warning">Oczekuje</span>
                    {% else %}
                        {{ sms.status }}
                    {% endif %}
                </td>
                <td>{{ sms.phone }}</td>
                <td style="max-width:320px;">
                    <div class="message-box">
                        <pre>{{ sms.content }}</pre>
                    </div>
                </td>
                <td>{{ sms.error_message or '-' }}</td>
                <td>{{ sms.created_at.strftime("%d.%m.%Y %H:%M") }}</td>
                <td>{{ sms.sent_at.strftime("%d.%m.%Y %H:%M") if sms.sent_at else "-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>Brak wys≈Çanych SMS dla tej wizyty.</p>
    {% endif %}
</div>

<!-- ===================== -->
<!-- EMAIL -->
<!-- ===================== -->

<div class="section">
    <h3>üìß Historia maili</h3>

    {% if emails %}
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Typ</th>
                <th>Status</th>
                <th>Do</th>
                <th>Temat</th>
                <th>Tre≈õƒá</th>
                <th>B≈ÇƒÖd</th>
                <th>Utworzono</th>
                <th>Wys≈Çano</th>
            </tr>
        </thead>
        <tbody>
            {% for mail in emails %}
            <tr>
                <td>{{ mail.id }}</td>

                <td>{{ mail.type }}</td>

                <td>
                    {% if mail.status == "sent" %}
                        <span class="label label-success">Wys≈Çany</span>
                    {% elif mail.status == "failed" %}
                        <span class="label label-danger">B≈ÇƒÖd</span>
                    {% elif mail.status == "pending" %}
                        <span class="label label-warning">Oczekuje</span>
                    {% else %}
                        {{ mail.status }}
                    {% endif %}
                </td>

                <td>{{ mail.email }}</td>

                <td style="max-width:250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    {{ mail.subject }}
                </td>
                <td style="max-width:350px;">
                   <div class="message-box">
                    <div style="white-space: normal;">
                        {{ mail.content | safe }}
                    </div>
                </div>
                </td>

                <td>{{ mail.error_message or '-' }}</td>

               <td>{{ mail.created_at.strftime("%d.%m.%Y %H:%M") }}</td>
                <td>{{ mail.sent_at.strftime("%d.%m.%Y %H:%M") if mail.sent_at else "-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>Brak wys≈Çanych maili dla tej wizyty.</p>
    {% endif %}
</div>


<!-- ===================== -->
<!-- P≈ÅATNO≈öCI -->
<!-- ===================== -->

<div class="section">
    <h3>üí≥ Historia p≈Çatno≈õci</h3>

    {% if payments %}
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Provider</th>
                <th>Status</th>
                <th>Kwota</th>
                <th>Waluta</th>
                <th>Session ID</th>
                <th>Order ID</th>
                <th>Utworzono</th>
                <th>Zap≈Çacono</th>
            </tr>
        </thead>
        <tbody>
            {% for p in payments %}
            <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.provider }}</td>
                <td>
                    {% if p.status == "paid" %}
                        <span class="label label-success">Op≈Çacona</span>
                    {% elif p.status == "pending" %}
                        <span class="label label-warning">Oczekuje</span>
                    {% elif p.status == "failed" %}
                        <span class="label label-danger">Nieudana</span>
                    {% elif p.status == "cancelled" %}
                        <span class="label label-default">Anulowana</span>
                    {% elif p.status == "refunded" %}
                        <span class="label label-info">Zwrot</span>
                    {% else %}
                        {{ p.status }}
                    {% endif %}
                </td>
                <td>{{ "%.2f"|format(p.amount / 100) }}</td>
                <td>{{ p.currency }}</td>
                <td>{{ p.provider_session_id }}</td>
                <td>{{ p.provider_order_id or '-' }}</td>
                <td>{{ p.created_at.strftime("%d.%m.%Y %H:%M") }}</td>
                <td>{{ p.paid_at.strftime("%d.%m.%Y %H:%M") if p.paid_at else "-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>Brak p≈Çatno≈õci dla tej wizyty.</p>
    {% endif %}
</div>

</div>

</body>
</html>
