{% extends "doctor/layout.html" %}

{% block content %}
<div class="container-fluid">

  <!-- ===== NAG≈Å√ìWEK ===== -->
  <div class="row">
    <div class="col-md-6">
      <h2>‚õî Czarna lista</h2>
    </div>
    <div class="col-md-6 text-right">
      <button class="btn btn-danger" data-toggle="modal" data-target="#addBlacklistModal">
        ‚ûï Dodaj pacjenta
      </button>
    </div>
  </div>

  <br>

  <!-- ===== WYSZUKIWANIE (ENTER / BUTTON) ===== -->
  <form method="get" id="searchForm" class="form-inline" style="margin-bottom:15px;">
    <div class="form-group">
      <input
        type="text"
        name="q"
        class="form-control"
        placeholder="Szukaj: imiƒô, nazwisko, telefon"
        value="{{ request.args.get('q', '') }}"
        style="width:300px;"
      >
    </div>

    <button type="submit" class="btn btn-primary" style="margin-left:10px;">
      üîç Szukaj
    </button>
  </form>

  <!-- ===== TABELA ===== -->
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Imiƒô</th>
        <th>Nazwisko</th>
        <th>Telefon</th>
        <th>Email</th>
        <th>Data blokady</th>
        <th>Status</th>
        <th>Akcje</th>
      </tr>
    </thead>

    <tbody>
    {% if items %}
      {% for p in items %}
        <!-- ===== WIERSZ G≈Å√ìWNY ===== -->
        <tr class="{% if not p.active %}text-muted{% endif %}">
          <td>{{ p.first_name }}</td>
          <td>{{ p.last_name }}</td>
          <td>{{ p.phone }}</td>
          <td>{{ p.email or "-" }}</td>
          <td>{{ p.blocked_at.strftime("%Y-%m-%d %H:%M") }}</td>
          <td>
            {% if p.active %}
              <span class="label label-danger">Zablokowany</span>
            {% else %}
              <span class="label label-default">Odblokowany</span>
            {% endif %}
          </td>
          <td>
            <form method="post"
                  action="{{ url_for('doctor.blacklist_toggle', item_id=p.id) }}"
                  style="display:inline;">
              <button class="btn btn-xs btn-default">
                {{ "Odblokuj" if p.active else "Zablokuj" }}
              </button>
            </form>

            <form method="post"
                  action="{{ url_for('doctor.blacklist_delete', item_id=p.id) }}"
                  style="display:inline;"
                  onsubmit="return confirm('UsunƒÖƒá wpis z czarnej listy?');">
              <button class="btn btn-xs btn-danger">
                Usu≈Ñ
              </button>
            </form>
          </td>
        </tr>

        <!-- ===== WIERSZ OPISU ===== -->
        {% if p.description %}
        <tr class="blacklist-description">
          <td colspan="7">
            <strong>Pow√≥d blokady:</strong><br>
            {{ p.description }}
          </td>
        </tr>
        {% endif %}
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="7" class="text-muted text-center">
          Brak pacjent√≥w na czarnej li≈õcie
        </td>
      </tr>
    {% endif %}
    </tbody>
  </table>

</div>

<!-- ============================= -->
<!-- MODAL: DODAJ PACJENTA -->
<!-- ============================= -->
<div class="modal fade" id="addBlacklistModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <form method="post" action="{{ url_for('doctor.blacklist_add') }}">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">‚ûï Dodaj pacjenta do czarnej listy</h4>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Imiƒô *</label>
            <input type="text" name="first_name" class="form-control" required>
          </div>

          <div class="form-group">
            <label>Nazwisko *</label>
            <input type="text" name="last_name" class="form-control" required>
          </div>

          <div class="form-group">
            <label>Telefon *</label>
            <input type="text" name="phone" class="form-control" required>
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" class="form-control">
          </div>

          <div class="form-group">
            <label>Pow√≥d blokady</label>
            <textarea name="description" class="form-control" rows="4"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">
            Anuluj
          </button>
          <button type="submit" class="btn btn-danger">
            Zapisz
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<!-- ===== STYL OPISU ===== -->
<style>
.blacklist-description td {
  background: #fff3cd;
  font-size: 13px;
  color: #856404;
}
</style>

<!-- ===== JS: FOCUS + ENTER ===== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('searchForm');
  const input = form.querySelector('input[name="q"]');

  if (input) {
    input.focus();

    // kursor na koniec
    const v = input.value;
    input.value = '';
    input.value = v;

    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        form.submit();
      }
    });
  }
});
</script>

{% endblock %}
