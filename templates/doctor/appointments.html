{% extends "doctor/layout.html" %}

{% block content %}

{# =================================================
   MACRO: LINK SORTOWANIA
   ================================================= #}
{% macro sort_link(label, field) %}
    {% if sort == field and dir == "asc" %}
        {% set new_dir = "desc" %}
    {% else %}
        {% set new_dir = "asc" %}
    {% endif %}

    <a href="{{ url_for('doctor.appointments',
        q=q,
        show_past='1' if show_past else None,
        sort=field,
        dir=new_dir
    ) }}">
        {{ label }}
        {% if sort == field %}
            {% if dir == "asc" %}‚ñ≤{% else %}‚ñº{% endif %}
        {% endif %}
    </a>
{% endmacro %}

<h2>üìÖ Terminarz ‚Äì lista wizyt</h2>

{# =================================================
   FILTRY
   ================================================= #}
<form method="get" id="filtersForm" class="form-inline" style="margin-bottom:15px;">
    <input type="hidden" name="page" value="1">
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="hidden" name="dir" value="{{ dir }}">

    <div class="form-group">
        <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Szukaj: nazwisko, imiƒô, telefon, email"
            value="{{ q or '' }}"
            style="width:300px;"
        >
    </div>

    <div class="checkbox" style="margin-left:10px;">
        <label>
            <input type="checkbox"
                   name="show_past"
                   value="1"
                   {% if show_past %}checked{% endif %}>
            poka≈º odbyte wizyty
        </label>
    </div>

    <button type="submit" class="btn btn-primary" style="margin-left:10px;">
        üîç Filtruj
    </button>

    {% if q or show_past %}
        <a href="{{ url_for('doctor.appointments') }}"
           class="btn btn-default"
           style="margin-left:5px;">
            ‚úñ Wyczy≈õƒá
        </a>
    {% endif %}
</form>

{# =================================================
   TABELA
   ================================================= #}
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>{{ sort_link("Data", "start") }}</th>
            <th>Godzina</th>
            <th>{{ sort_link("Pacjent", "patient_last_name") }}</th>
            <th>{{ sort_link("Telefon", "patient_phone") }}</th>
            <th>{{ sort_link("Email", "patient_email") }}</th>
            <th>{{ sort_link("Typ", "visit_type") }}</th>
            <th>{{ sort_link("Status", "status") }}</th>
            <th></th>
        </tr>
    </thead>
    <tbody>

    {% for a in appointments %}
        <tr class="
            {% if a.status == 'completed' %}active{% endif %}
            {% if a.status == 'cancelled' %}danger{% endif %}
        ">
            <td>{{ a.start.strftime('%Y-%m-%d') }}</td>

            <td>
                {{ a.start.strftime('%H:%M') }} ‚Äì {{ a.end.strftime('%H:%M') }}
            </td>

            <td>{{ a.patient_first_name }} {{ a.patient_last_name }}</td>

            <td>{{ a.patient_phone }}</td>

            <td>
                {% if a.patient_email %}
                    <a href="mailto:{{ a.patient_email }}">{{ a.patient_email }}</a>
                {% else %}
                    <span class="text-muted">‚Äî</span>
                {% endif %}
            </td>

            <td>{{ a.visit_type }}</td>

            <td>
                {% if a.status == "scheduled" %}
                    <span class="label label-primary">zaplanowana</span>
                {% elif a.status == "completed" %}
                    <span class="label label-default">odbyta</span>
                {% elif a.status == "cancelled" %}
                    <span class="label label-danger">anulowana</span>
                {% endif %}
            </td>

            <td style="white-space:nowrap;">
              {% if a.status == "scheduled" %}

                <form method="post"
                      action="{{ url_for('doctor.complete_appointment', appointment_id=a.id) }}"
                      style="display:inline;">
                  <input type="hidden" name="show_past" value="{{ '1' if show_past else '' }}">
                  <input type="hidden" name="q" value="{{ q }}">
                  <input type="hidden" name="page" value="{{ pagination.page }}">
                  <input type="hidden" name="sort" value="{{ sort }}">
                  <input type="hidden" name="dir" value="{{ dir }}">
                  <button class="btn btn-success btn-xs">‚úî Zrealizowana</button>
                </form>

                <form method="post"
                      action="{{ url_for('doctor.cancel_appointment', appointment_id=a.id) }}"
                      style="display:inline; margin-left:4px;">
                  <input type="hidden" name="show_past" value="{{ '1' if show_past else '' }}">
                  <input type="hidden" name="q" value="{{ q }}">
                  <input type="hidden" name="page" value="{{ pagination.page }}">
                  <input type="hidden" name="sort" value="{{ sort }}">
                  <input type="hidden" name="dir" value="{{ dir }}">
                  <button class="btn btn-danger btn-xs">‚ùå Anuluj</button>
                </form>

              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
        </tr>
    {% endfor %}

    </tbody>
</table>

{# =================================================
   PAGINACJA
   ================================================= #}
{% if pagination %}
<nav class="text-center">
  <ul class="pagination">

    {% if pagination.has_prev %}
      <li>
        <a href="{{ url_for('doctor.appointments',
            page=pagination.prev_num,
            q=q,
            show_past='1' if show_past else None,
            sort=sort,
            dir=dir
        ) }}">&laquo;</a>
      </li>
    {% endif %}

    {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
      {% if p %}
        <li class="{% if p == pagination.page %}active{% endif %}">
          <a href="{{ url_for('doctor.appointments',
              page=p,
              q=q,
              show_past='1' if show_past else None,
              sort=sort,
              dir=dir
          ) }}">{{ p }}</a>
        </li>
      {% else %}
        <li class="disabled"><span>‚Ä¶</span></li>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
      <li>
        <a href="{{ url_for('doctor.appointments',
            page=pagination.next_num,
            q=q,
            show_past='1' if show_past else None,
            sort=sort,
            dir=dir
        ) }}">&raquo;</a>
      </li>
    {% endif %}

  </ul>
</nav>

<p class="text-muted text-center">
    Wy≈õwietlono {{ pagination.items|length }} z {{ pagination.total }} wizyt
</p>
{% endif %}

{% if not appointments %}
<div class="alert alert-info">
    Brak wizyt spe≈ÇniajƒÖcych kryteria.
</div>
{% endif %}

{# =================================================
   AUTO-SUBMIT CHECKBOXA
   ================================================= #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('filtersForm');
  const input = form.querySelector('input[name="q"]');
  const checkbox = form.querySelector('input[name="show_past"]');

  // ‚úÖ ZAWSZE ustaw focus na polu wyszukiwania po reloadzie
  if (input) {
    input.focus();

    // opcjonalnie: kursor na koniec tekstu
    const val = input.value;
    input.value = '';
    input.value = val;
  }

  // ‚å®Ô∏è ENTER w polu wyszukiwania = submit
  if (input) {
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        const pageInput = form.querySelector('input[name="page"]');
        if (pageInput) pageInput.value = 1;
        form.submit();
      }
    });
  }

  // ‚òëÔ∏è checkbox = auto-submit (jak by≈Ço)
  if (checkbox) {
    checkbox.addEventListener('change', function () {
      const pageInput = form.querySelector('input[name="page"]');
      if (pageInput) pageInput.value = 1;
      form.submit();
    });
  }
});
</script>


{% endblock %}
