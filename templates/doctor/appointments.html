{% extends "doctor/layout.html" %}

{% block content %}

<style>
  /* ===== FILTRY ===== */

  .filters-row {
    margin-bottom: 6px;
  }

  .filters-row input,
  .filters-row select {
    height: 38px;
    font-size: 14px;
  }

  .filters-row .form-control {
    padding: 6px 10px;
  }

  /* SELECTY ‚Äì +40% */
  .filter-select {
    height: 46px !important;
    padding: 10px 12px !important;
    font-size: 14px;
    font-weight: 500;
  }

  /* MNIEJSZE ODSTƒòPY */
  .filters-row > div {
    padding-left: 6px;
    padding-right: 6px;
  }

  .show-past-box {
  display: flex;
  align-items: center;
  height: 46px;
}

.show-past-box .form-check {
  margin: 0;
  padding-left: 2.5em;
}

.show-past-box .form-check-input {
  width: 2.5em;
  height: 1.4em;
  cursor: pointer;
}

.show-past-box .form-check-label {
  font-size: 14px;
  cursor: pointer;
  user-select: none;
}


  /* PRZYCISKI */
  .filters-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    height: 46px;
  }

  .filters-actions .btn {
    min-width: 150px;
    height: 44px;
    font-size: 15px;
    margin-left: 6px;
  }

  .filters-separator {
    margin: 12px 0 10px;
  }


/* WSP√ìLNE */
.badge-status {
  display: inline-block;
  min-width: 95px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  border-radius: 6px;
  line-height: 1.2;
}

/* üîµ ZAPLANOWANA */
.badge-scheduled {
  background-color: #0d6efd; /* bootstrap blue */
  color: #fff;
}

/* üü¢ ZREALIZOWANA */
.badge-completed {
  background-color: #d4edda;
  color: #155724;
}



/* üî¥ ANULOWANA ‚Äì jasna */
.badge-cancelled {
  background-color: #f8d7da;
  color: #842029;
}

</style>

{% macro sort_link(label, field) %}
  {% set new_dir = "desc" if sort == field and dir == "asc" else "asc" %}
  <a href="{{ url_for(
      'doctor.appointments',
      page=1,
      sort=field,
      dir=new_dir,

      first_name=request.args.get('first_name'),
      last_name=request.args.get('last_name'),
      phone=request.args.get('phone'),
      email=request.args.get('email'),

      visit_type=request.args.get('visit_type'),
      status=request.args.get('status'),
      created_by=request.args.get('created_by'),

      date_from=request.args.get('date_from'),
      date_to=request.args.get('date_to'),
      show_past=request.args.get('show_past')
  ) }}">
    {{ label }}
    {% if sort == field %}
      {% if dir == "asc" %}‚ñ≤{% else %}‚ñº{% endif %}
    {% endif %}
  </a>
{% endmacro %}


<h2>üìÖ Terminarz ‚Äì lista wizyt</h2>

<form method="get">

  <input type="hidden" name="page" value="1">
  <input type="hidden" name="sort" value="{{ sort }}">
  <input type="hidden" name="dir" value="{{ dir }}">

  <!-- ===== G√ìRNA BELKA ===== -->
  <div class="row filters-row align-items-center">

    <div class="col-md-2">
      <input type="date"
             name="date_from"
             class="form-control"
             value="{{ request.args.date_from }}">
    </div>

    <div class="col-md-2">
      <input type="date"
             name="date_to"
             class="form-control"
             value="{{ request.args.date_to }}">
    </div>

    <div class="col-md-3 show-past-box">
      <div class="form-check form-switch">
        <input class="form-check-input"
               type="checkbox"
               role="switch"
               id="showPastSwitch"
               name="show_past"
               value="1"
               {% if request.args.show_past == "1" %}checked{% endif %}>
        <label class="form-check-label" for="showPastSwitch">
          poka≈º przesz≈Çe wizyty
        </label>
      </div>
    </div>

    <div class="col-md-5 filters-actions">
      <button class="btn btn-primary">
        üîç Szukaj
      </button>
      <a href="{{ url_for('doctor.appointments') }}"
         class="btn btn-secondary">
        ‚úñ Reset
      </a>
    </div>

  </div>

  <hr class="filters-separator">

  <!-- ===== DOLNA BELKA ===== -->
  <div class="row filters-row">

    <div class="col-md-2">
      <input type="text"
             name="last_name"
             class="form-control"
             placeholder="Nazwisko"
             value="{{ request.args.last_name }}">
    </div>

    <div class="col-md-2">
      <input type="text"
             name="first_name"
             class="form-control"
             placeholder="Imiƒô"
             value="{{ request.args.first_name }}">
    </div>

    <div class="col-md-2">
      <input type="text"
             name="phone"
             class="form-control"
             placeholder="Telefon"
             value="{{ request.args.phone }}">
    </div>

    <div class="col-md-2">
      <input type="text"
             name="email"
             class="form-control"
             placeholder="Email"
             value="{{ request.args.email }}">
    </div>

    <div class="col-md-2">
      <select name="visit_type" class="form-control filter-select">
        <option value="">Typ wizyty</option>
        {% for vt in visit_types %}
          <option value="{{ vt.code }}"
            {% if request.args.visit_type == vt.code %}selected{% endif %}>
            {{ vt.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-1">
      <select name="status" class="form-control filter-select">
        <option value="">Status</option>
        <option value="scheduled"
          {% if request.args.status == "scheduled" %}selected{% endif %}>
          Zapl.
        </option>
        <option value="completed"
          {% if request.args.status == "completed" %}selected{% endif %}>
          Odbyta
        </option>
        <option value="cancelled"
          {% if request.args.status == "cancelled" %}selected{% endif %}>
          Anul.
        </option>
      </select>
    </div>

    <!-- üÜï ≈πR√ìD≈ÅO WIZYTY -->
    <div class="col-md-1">
      <select name="created_by" class="form-control filter-select">
        <option value="">≈πr√≥d≈Ço</option>
        <option value="patient"
          {% if request.args.created_by == "patient" %}selected{% endif %}>
          üë§
        </option>
        <option value="doctor"
          {% if request.args.created_by == "doctor" %}selected{% endif %}>
          ‚úçÔ∏è
        </option>
      </select>
    </div>

  </div>

</form>


<!-- ===== TABELA ===== -->
<!-- ===== TABELA ===== -->
<table class="table table-sm table-striped table-hover align-middle mt-3">
  <thead>
    <tr>
      <th>{{ sort_link("Data", "start") }}</th>
      <th>Godzina</th>
      <th>{{ sort_link("Nazwisko", "patient_last_name") }}</th>
      <th>Imiƒô</th>
      <th>{{ sort_link("Telefon", "patient_phone") }}</th>
      <th>Email</th>
      <th>{{ sort_link("Typ", "visit_type") }}</th>
      <!-- üÜï ≈πR√ìD≈ÅO -->
      <th class="text-center">
        {{ sort_link("≈πr√≥d≈Ço", "created_by") }}
      </th>
      <th>{{ sort_link("Status", "status") }}</th>
      <th></th>
    </tr>
  </thead>



 <tbody>
{% for a in appointments %}
  <tr>
    <td>{{ a.start.strftime('%Y-%m-%d') }}</td>
    <td>{{ a.start.strftime('%H:%M') }} ‚Äì {{ a.end.strftime('%H:%M') }}</td>
    <td>{{ a.patient_last_name }}</td>
    <td>{{ a.patient_first_name }}</td>
    <td>{{ a.patient_phone }}</td>
    <td>{{ a.patient_email or "‚Äî" }}</td>
    <td>{{ a.visit_type }}</td>

    <!-- üÜï ≈πR√ìD≈ÅO WIZYTY -->
    <td class="text-center">
      {% if a.created_by == "patient" %}
        <span title="Rezerwacja online">üë§</span>
      {% elif a.created_by == "doctor" %}
        <span title="Dodana rƒôcznie przez lekarza">‚úçÔ∏è</span>
      {% else %}
        ‚Äî
      {% endif %}
    </td>

    <!-- STATUS -->
    <td>
      {% if a.status == "scheduled" %}
        <span class="badge badge-status badge-scheduled">
          zaplanowana
        </span>
      {% elif a.status == "completed" %}
        <span class="badge badge-status badge-completed">
          zrealizowana
        </span>
      {% elif a.status == "cancelled" %}
        <span class="badge badge-status badge-cancelled">
          anulowana
        </span>
      {% endif %}
    </td>
    

    <!-- AKCJE -->
    <td>
      {% if a.status == "scheduled" %}

        <!-- ‚úî ZREALIZOWANA -->
        <form method="post"
              action="{{ url_for('doctor.complete_appointment', appointment_id=a.id) }}"
              style="display:inline">

          {% for k, v in request.args.items() %}
            <input type="hidden" name="{{ k }}" value="{{ v }}">
          {% endfor %}

          <button class="btn btn-sm btn-success"
                  title="Oznacz wizytƒô jako zrealizowanƒÖ">
            ‚úî
          </button>
        </form>

        <!-- ‚ùå ANULUJ -->
        <form method="post"
              action="{{ url_for('doctor.cancel_appointment', appointment_id=a.id) }}"
              style="display:inline; margin-left:4px;">

          {% for k, v in request.args.items() %}
            <input type="hidden" name="{{ k }}" value="{{ v }}">
          {% endfor %}

          <button class="btn btn-sm btn-danger"
                  title="Anuluj wizytƒô">
            ‚úñ
          </button>
        </form>

      {% else %}
        ‚Äî
      {% endif %}
    </td>

  </tr>
{% else %}
  <tr>
    <td colspan="10" class="text-center text-muted">
      Brak wizyt
    </td>
  </tr>
{% endfor %}
</tbody>


</table>
{% set args = request.args.to_dict() %}
{% if 'page' in args %}
  {% set _ = args.pop('page') %}
{% endif %}
{% if pagination.pages > 1 %}
<nav aria-label="Paginacja terminarza" class="mt-3">
  <ul class="pagination justify-content-center">

    {# ‚óÄ POPRZEDNIA #}
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link"
   href="{{ url_for(
     'doctor.appointments',
     page=pagination.prev_num,
     **args
   ) }}">
  ‚Äπ
</a>

    </li>

    {# NUMERY STRON #}
    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if p %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a class="page-link"
   href="{{ url_for(
     'doctor.appointments',
     page=p,
     **args
   ) }}">
  {{ p }}
</a>

        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">‚Ä¶</span>
        </li>
      {% endif %}
    {% endfor %}

    {# ‚ñ∂ NASTƒòPNA #}
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link"
   href="{{ url_for(
     'doctor.appointments',
     page=pagination.next_num,
     **args
   ) }}">
  ‚Ä∫
</a>

    </li>

  </ul>

  <p class="text-center text-muted small mt-1">
    Wy≈õwietlono {{ pagination.items|length }} z {{ pagination.total }} wizyt
  </p>
</nav>
{% endif %}



<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const showPast = document.getElementById("showPastSwitch");

  if (showPast && form) {
    showPast.addEventListener("change", function () {
      // zawsze resetuj paginacjƒô jak przy "Szukaj"
      const pageInput = form.querySelector('input[name="page"]');
      if (pageInput) pageInput.value = 1;

      form.submit();
    });
  }
});
</script>

{% endblock %}
