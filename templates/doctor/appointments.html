{% extends "doctor/layout.html" %}

{% block content %}

<style>
  /* ===== FILTRY ===== */

  .filters-row {
    margin-bottom: 6px;
  }

  .filters-row input,
  .filters-row select {
    height: 38px;
    font-size: 14px;
  }

  .filters-row .form-control {
    padding: 6px 10px;
  }

  /* SELECTY â€“ +40% */
  .filter-select {
    height: 46px !important;
    padding: 10px 12px !important;
    font-size: 14px;
    font-weight: 500;
  }

  /* MNIEJSZE ODSTÄ˜PY */
  .filters-row > div {
    padding-left: 6px;
    padding-right: 6px;
  }

  .show-past-box {
  display: flex;
  align-items: center;
  height: 46px;
}

.show-past-box .form-check {
  margin: 0;
  padding-left: 2.5em;
}

.show-past-box .form-check-input {
  width: 2.5em;
  height: 1.4em;
  cursor: pointer;
}

.show-past-box .form-check-label {
  font-size: 14px;
  cursor: pointer;
  user-select: none;
}


  /* PRZYCISKI */
  .filters-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    height: 46px;
  }

  .filters-actions .btn {
    min-width: 150px;
    height: 44px;
    font-size: 15px;
    margin-left: 6px;
  }

  .filters-separator {
    margin: 12px 0 10px;
  }


/* WSPÃ“LNE */
.badge-status {
  display: inline-block;
  min-width: 95px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  border-radius: 6px;
  line-height: 1.2;
}

/* ğŸ”µ ZAPLANOWANA */
.badge-scheduled {
  background-color: #0d6efd; /* bootstrap blue */
  color: #fff;
}

/* ğŸŸ¢ ZREALIZOWANA */
.badge-completed {
  background-color: #d4edda;
  color: #155724;
}



/* ğŸ”´ ANULOWANA â€“ jasna */
.badge-cancelled {
  background-color: #f8d7da;
  color: #842029;
}

</style>

{% macro sort_link(label, field) %}
  {% set new_dir = "desc" if sort == field and dir == "asc" else "asc" %}
  <a href="{{ url_for(
      'doctor.appointments',
      page=1,
      sort=field,
      dir=new_dir,

      first_name=request.args.get('first_name'),
      last_name=request.args.get('last_name'),
      phone=request.args.get('phone'),
      email=request.args.get('email'),

      visit_type=request.args.get('visit_type'),
      status=request.args.get('status'),
      created_by=request.args.get('created_by'),
      client_ip=request.args.get('client_ip'),


      date_from=request.args.get('date_from'),
      date_to=request.args.get('date_to'),
      show_past=request.args.get('show_past')
  ) }}">
    {{ label }}
    {% if sort == field %}
      {% if dir == "asc" %}â–²{% else %}â–¼{% endif %}
    {% endif %}
  </a>
{% endmacro %}


<h2>ğŸ“… Terminarz â€“ lista wizyt</h2>

<form method="get">

  <input type="hidden" name="page" value="1">
  <input type="hidden" name="sort" value="{{ sort }}">
  <input type="hidden" name="dir" value="{{ dir }}">

  <!-- ===== GÃ“RNA BELKA ===== -->
  <div class="row filters-row align-items-center">

    <div class="col-md-2">
      <input type="date"
             name="date_from"
             class="form-control"
             value="{{ request.args.date_from }}">
    </div>

    <div class="col-md-2">
      <input type="date"
             name="date_to"
             class="form-control"
             value="{{ request.args.date_to }}">
    </div>

    <div class="col-md-3 show-past-box">
      <div class="form-check form-switch">
        <input class="form-check-input"
               type="checkbox"
               role="switch"
               id="showPastSwitch"
               name="show_past"
               value="1"
               {% if request.args.show_past == "1" %}checked{% endif %}>
        <label class="form-check-label" for="showPastSwitch">
          pokaÅ¼ przeszÅ‚e wizyty
        </label>
      </div>
    </div>

    <div class="col-md-5 filters-actions">
      <button class="btn btn-primary">
        ğŸ” Szukaj
      </button>
      <a href="{{ url_for('doctor.appointments') }}"
         class="btn btn-secondary">
        âœ– Reset
      </a>
    </div>

  </div>

  <hr class="filters-separator">

  <!-- ===== DOLNA BELKA ===== -->
  <div class="row filters-row">

    <div class="col-md-2">
      <input type="text"
             name="last_name"
             class="form-control"
             placeholder="Nazwisko"
             value="{{ request.args.last_name }}">
    </div>

    <div class="col-md-2">
      <input type="text"
             name="first_name"
             class="form-control"
             placeholder="ImiÄ™"
             value="{{ request.args.first_name }}">
    </div>

    <div class="col-md-2">
      <input type="text"
             name="phone"
             class="form-control"
             placeholder="Telefon"
             value="{{ request.args.phone }}">
    </div>

    <div class="col-md-2">
      <input type="text"
             name="email"
             class="form-control"
             placeholder="Email"
             value="{{ request.args.email }}">
    </div>
    
    <div class="col-md-2">
      <input type="text"
            name="client_ip"
            class="form-control"
            placeholder="IP klienta"
            value="{{ request.args.client_ip }}">
    </div>

    <div class="col-md-2">
      <select name="visit_type" class="form-control filter-select">
        <option value="">Typ wizyty</option>
        {% for vt in visit_types %}
          <option value="{{ vt.code }}"
            {% if request.args.visit_type == vt.code %}selected{% endif %}>
            {{ vt.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <select name="status" class="form-control filter-select">
        <option value="">Status</option>
        <option value="scheduled"
          {% if request.args.status == "scheduled" %}selected{% endif %}>
          Zaplanowana
        </option>
        <option value="completed"
          {% if request.args.status == "completed" %}selected{% endif %}>
          Zrealizowana
        </option>
        <option value="cancelled"
          {% if request.args.status == "cancelled" %}selected{% endif %}>
          Anulowana
        </option>
      </select>
    </div>

    <!-- ğŸ†• Å¹RÃ“DÅO WIZYTY -->
    <div class="col-md-2">
      <select name="created_by" class="form-control filter-select">
        <option value="">Å¹rÃ³dÅ‚o</option>
        <option value="patient"
          {% if request.args.created_by == "patient" %}selected{% endif %}>
          ğŸ‘¤
        </option>
        <option value="doctor"
          {% if request.args.created_by == "doctor" %}selected{% endif %}>
          âœï¸
        </option>
      </select>
    </div>

  </div>

</form>


<!-- ===== TABELA ===== -->
<!-- ===== TABELA ===== -->
<table class="table table-sm table-striped table-hover align-middle mt-3">
 <thead>
  <tr>
    <th>{{ sort_link("Data", "start") }}</th>
    <th>Godzina</th>
    <th>{{ sort_link("Nazwisko", "patient_last_name") }}</th>
    <th>{{ sort_link("ImiÄ™", "patient_first_name") }}</th>
    <th>{{ sort_link("Status", "status") }}</th>
    <th class="text-center">
      {{ sort_link("Å¹rÃ³dÅ‚o", "created_by") }}
    </th>
    <th>{{ sort_link("Telefon", "patient_phone") }}</th>
    <th>{{ sort_link("Email", "patient_email") }}</th>
    <th>{{ sort_link("IP", "client_ip") }}</th>
    <th class="text-center">ğŸ’³</th>
    <th>{{ sort_link("Typ", "visit_type") }}</th>
    <th></th>
  </tr>
</thead>

 <tbody>
{% for a in appointments %}
  <tr>
  <td>{{ a.start.strftime('%Y-%m-%d') }}</td>
  <td>{{ a.start.strftime('%H:%M') }} â€“ {{ a.end.strftime('%H:%M') }}</td>

  <td>{{ a.patient_last_name }}</td>
  <td>{{ a.patient_first_name }}</td>

  <!-- STATUS -->
  <td>
    {% if a.status == "scheduled" %}
      <span class="badge badge-status badge-scheduled">
        zaplanowana
      </span>
    {% elif a.status == "completed" %}
      <span class="badge badge-status badge-completed">
        zrealizowana
      </span>
    {% elif a.status == "cancelled" %}
      <span class="badge badge-status badge-cancelled">
        anulowana
      </span>
    {% endif %}
  </td>

  <!-- Å¹RÃ“DÅO -->
  <td class="text-center">
    {% if a.created_by == "patient" %}
      <span title="Rezerwacja online">ğŸ‘¤</span>
    {% elif a.created_by == "doctor" %}
      <span title="Dodana rÄ™cznie przez lekarza">âœï¸</span>
    {% else %}
      â€”
    {% endif %}
  </td>

  <td>{{ a.patient_phone }}</td>
  <td>{{ a.patient_email or "â€”" }}</td>

  <td>
    {% if a.client_ip %}
      <code>{{ a.client_ip }}</code>
    {% else %}
      â€”
    {% endif %}
  </td>

  <td class="text-center">
  {% set provider = a.payment_provider %}

  {% if not provider %}
      <span title="PÅ‚atnoÅ›Ä‡ w gabinecie">ğŸ’µ</span>

  {% elif provider == "manual_transfer" %}
      <span title="Przelew tradycyjny">ğŸ¦</span>

  {% elif provider in ["p24", "przelewy24"] %}
      <span title="Przelewy24">ğŸŸ£</span>

  {% else %}
      â€”
  {% endif %}
</td>


  <td>{{ a.visit_type }}</td>

  <!-- AKCJE -->
<td>

  <!-- ğŸ” SZCZEGÃ“ÅY â€“ ZAWSZE DOSTÄ˜PNE -->
  <a href="{{ url_for('doctor.appointment_details', appointment_id=a.id) }}"
     target="_blank"
     class="btn btn-sm btn-primary">
     ğŸ”
  </a>

  {% if a.status == "scheduled" %}

      {# ============================= #}
      {# âœ” ZREALIZUJ #}
      {# ============================= #}

      {% set provider = a.payment_provider %}
      {% set payment_status = a.payment_status %}

      {% if not provider %}
          <form method="post"
                action="{{ url_for('doctor.complete_appointment', appointment_id=a.id) }}"
                style="display:inline">
            {% for k, v in request.args.items() %}
              <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endfor %}
            <button class="btn btn-sm btn-success js-confirm-complete">
              âœ”
            </button>
          </form>
      {% endif %}

      {% if provider and payment_status == "paid" %}
          <form method="post"
                action="{{ url_for('doctor.complete_appointment', appointment_id=a.id) }}"
                style="display:inline">
            {% for k, v in request.args.items() %}
              <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endfor %}
            <button class="btn btn-sm btn-success js-confirm-complete">
              âœ”
            </button>
          </form>
      {% endif %}

      {% if provider and payment_status == "pending" %}
          <form method="post"
                action="{{ url_for('doctor.mark_paid', appointment_id=a.id) }}"
                style="display:inline">
            {% for k, v in request.args.items() %}
              <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endfor %}
            <button class="btn btn-sm btn-warning js-confirm-paid">
              ğŸ’°
            </button>
          </form>
      {% endif %}

      <form method="post"
            action="{{ url_for('doctor.cancel_appointment', appointment_id=a.id) }}"
            style="display:inline; margin-left:4px;">
        {% for k, v in request.args.items() %}
          <input type="hidden" name="{{ k }}" value="{{ v }}">
        {% endfor %}
        <button class="btn btn-sm btn-danger js-confirm-cancel">
          âœ–
        </button>
      </form>

  {% endif %}

</td>

</tr>
{% else %}
  <tr>
    <td colspan="12" class="text-center text-muted">
      Brak wizyt
    </td>
  </tr>
{% endfor %}
</tbody>


</table>
{% set args = request.args.to_dict() %}
{% if 'page' in args %}
  {% set _ = args.pop('page') %}
{% endif %}
{% if pagination.pages > 1 %}
<nav aria-label="Paginacja terminarza" class="mt-3">
  <ul class="pagination justify-content-center">

    {# â—€ POPRZEDNIA #}
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link"
   href="{{ url_for(
     'doctor.appointments',
     page=pagination.prev_num,
     **args
   ) }}">
  â€¹
</a>

    </li>

    {# NUMERY STRON #}
    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if p %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a class="page-link"
   href="{{ url_for(
     'doctor.appointments',
     page=p,
     **args
   ) }}">
  {{ p }}
</a>

        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">â€¦</span>
        </li>
      {% endif %}
    {% endfor %}

    {# â–¶ NASTÄ˜PNA #}
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link"
   href="{{ url_for(
     'doctor.appointments',
     page=pagination.next_num,
     **args
   ) }}">
  â€º
</a>

    </li>

  </ul>

  <p class="text-center text-muted small mt-1">
    WyÅ›wietlono {{ pagination.items|length }} z {{ pagination.total }} wizyt
  </p>
</nav>
{% endif %}



<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const showPast = document.getElementById("showPastSwitch");

  if (showPast && form) {
    showPast.addEventListener("change", function () {
      // zawsze resetuj paginacjÄ™ jak przy "Szukaj"
      const pageInput = form.querySelector('input[name="page"]');
      if (pageInput) pageInput.value = 1;

      form.submit();
    });
  }
});

document.addEventListener("DOMContentLoaded", function () {

  // âœ” ZREALIZOWANA
  document.querySelectorAll(".js-confirm-complete")
    .forEach(btn => {
      btn.addEventListener("click", function (e) {
        if (!confirm("OznaczyÄ‡ wizytÄ™ jako zrealizowanÄ…?")) {
          e.preventDefault();
        }
      });
    });

  // âœ– ANULOWANA
  document.querySelectorAll(".js-confirm-cancel")
    .forEach(btn => {
      btn.addEventListener("click", function (e) {
        if (!confirm("Na pewno anulowaÄ‡ wizytÄ™?")) {
          e.preventDefault();
        }
      });
    });

});

// ğŸ’° OZNACZ JAKO OPÅACONA
document.querySelectorAll(".js-confirm-paid")
  .forEach(btn => {
    btn.addEventListener("click", function (e) {
      if (!confirm("OznaczyÄ‡ wizytÄ™ jako opÅ‚aconÄ…?")) {
        e.preventDefault();
      }
    });
  });

</script>

{% endblock %}
