{% extends "doctor/layout.html" %}

{% block title %}SMS{% endblock %}

{% block content %}
<div class="container-fluid">

  <h2 class="mb-3">ðŸ“¨ Historia SMS</h2>

  <!-- FILTRY -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-2">
      <input type="text" name="phone" class="form-control"
             placeholder="Telefon"
             value="{{ request.args.phone }}">
    </div>

    <div class="col-md-2">
      <select name="type" class="form-control">
        <option value="">Typ</option>
        <option value="confirmation" {% if request.args.type == "confirmation" %}selected{% endif %}>
          Confirmation
        </option>
        <option value="reminder" {% if request.args.type == "reminder" %}selected{% endif %}>
          Reminder
        </option>
      </select>
    </div>

    <div class="col-md-2">
      <select name="status" class="form-control">
        <option value="">Status</option>
        <option value="pending" {% if request.args.status == "pending" %}selected{% endif %}>Pending</option>
        <option value="sent" {% if request.args.status == "sent" %}selected{% endif %}>Sent</option>
        <option value="failed" {% if request.args.status == "failed" %}selected{% endif %}>Failed</option>
      </select>
    </div>

    <div class="col-md-2">
      <input type="number" name="appointment_id" class="form-control"
             placeholder="Appointment ID"
             value="{{ request.args.appointment_id }}">
    </div>

    <div class="col-md-2">
      <input type="date" name="date_from" class="form-control"
             value="{{ request.args.date_from }}">
    </div>

    <div class="col-md-2">
      <input type="date" name="date_to" class="form-control"
             value="{{ request.args.date_to }}">
    </div>

    <div class="col-md-12 text-end">
      <button class="btn btn-primary">Szukaj</button>
      <a href="{{ url_for('doctor.sms_list') }}" class="btn btn-secondary">
        Reset
      </a>
    </div>
  </form>

  <!-- TABELA -->
  <table class="table table-sm table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Appointment</th>
        <th>Telefon</th>
        <th>Typ</th>
        <th>Status</th>
        <th>TreÅ›Ä‡</th>
        <th>Provider ID</th>
        <th>BÅ‚Ä…d</th>
        <th>Utworzono</th>
        <th>WysÅ‚ano</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody>
      {% for sms in sms_messages %}
      <tr>
        <td>{{ sms.id }}</td>
        <td>{{ sms.appointment_id }}</td>
        <td>{{ sms.phone }}</td>
        <td>{{ sms.type }}</td>
        <td>
          {% if sms.status == "sent" %}
            <span class="badge bg-success">sent</span>
          {% elif sms.status == "failed" %}
            <span class="badge bg-danger">failed</span>
          {% else %}
            <span class="badge bg-secondary">pending</span>
          {% endif %}
        </td>

        <!-- TREÅšÄ† SMS -->
        <td style="max-width: 320px;">
          <pre class="small mb-0 text-wrap">{{ sms.content }}</pre>
        </td>

        <td>{{ sms.provider_message_id or "â€”" }}</td>
        <td class="text-danger small">{{ sms.error_message or "â€”" }}</td>
        <td>{{ sms.created_at }}</td>
        <td>{{ sms.sent_at or "â€”" }}</td>

        <!-- AKCJE -->
        <td>
          {% if sms.status == "failed" %}
            <form method="post"
                  action="{{ url_for('doctor.sms_retry', sms_id=sms.id) }}"
                  style="display:inline">
              <button class="btn btn-sm btn-outline-warning"
                      onclick="return confirm('WysÅ‚aÄ‡ SMS ponownie?')">
                Retry
              </button>
            </form>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="11" class="text-center text-muted">
          Brak wiadomoÅ›ci
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% if pagination.pages > 1 %}
<nav aria-label="Paginacja SMS">
  <ul class="pagination justify-content-center mt-3">

    <!-- PREV -->
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('doctor.sms_list',
                          page=pagination.prev_num,
                          **pagination_args) }}">
        â€¹
      </a>
    </li>

    <!-- NUMERY STRON -->
    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if p %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}">
          <a class="page-link"
             href="{{ url_for('doctor.sms_list',
                              page=p,
                              **pagination_args) }}">
            {{ p }}
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">â€¦</span>
        </li>
      {% endif %}
    {% endfor %}

    <!-- NEXT -->
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('doctor.sms_list',
                          page=pagination.next_num,
                          **pagination_args) }}">
        â€º
      </a>
    </li>

  </ul>
</nav>
{% endif %}

</div>
{% endblock %}
