{% extends "patient/layout.html" %}

{% block title %}Rezerwacja wizyty{% endblock %}

{% block content %}
<div class="patient-page">

<style>
  .has-error {
    border-color: #d9534f !important;
    box-shadow: 0 0 6px rgba(217,83,79,.4);
  }

  .field-error {
    color: #d9534f;
    font-size: 13px;
    margin-top: 4px;
    display: none;
  }

  .calendar-day.disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .calendar-day.available {
    cursor: pointer;
    font-weight: bold;
  }

  .calendar-day.selected {
    background: #337ab7;
    color: #fff;
    border-radius: 4px;
  }

  /* ===== GODZINY ===== */
  .hours {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .hour-btn {
    width: calc(25% - 8px);      /* mobile: 4 */
    height: 44px;
    border: 1px solid #337ab7;
    background: #fff;
    color: #337ab7;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (min-width: 768px) {
    .hour-btn {
      width: calc(12.5% - 9px);  /* desktop: 8 */
    }
  }

  .hour-btn:hover {
    background: #eef5ff;
  }

  .hour-btn.selected {
    background: #337ab7;
    color: #fff;
  }
  /* ===== WSPÓLNY STYL PRZYCISKÓW ===== */

.btn-book {
  width: 100%;
  height: 50px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.2s ease;
  border: none;
}

/* Rezerwuj */
#btn_reserve {
  background-color: #337ab7;
  color: #fff;
}

#btn_reserve:hover {
  background-color: #286090;
}

/* Zapłać */
#btn_pay {
  background-color: #d73930;
  color: #fff;
}

#btn_pay:hover {
  background-color: #b92d25;
}

/* Disabled */
.btn-book:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Przelew tradycyjny */
#btn_traditional {
  background-color: #f0ad4e;
  color: #fff;
}

#btn_traditional:hover {
  background-color: #ec971f;
}


</style>

<div class="container-fluid">
<button type="button"
        class="btn btn-link"
        onclick="window.history.back();"
        style="margin-bottom:10px;">
  ← Wróć na stronę główną
</button>
  <h2>Rezerwacja wizyty</h2>

  <label>Rodzaj wizyty</label>
  <select id="visit_type" class="form-control">
    <option value="">-- wybierz --</option>
  </select>

  <div class="info" id="visit_info"></div>

  <!-- ================= KALENDARZ ================= -->
  <div id="calendar_wrapper" style="display:none;">
    <hr>

    <div class="calendar-header">
      <button id="prev_month" class="btn btn-default btn-lg">⟨</button>
      <strong id="calendar_title"></strong>
      <button id="next_month" class="btn btn-default btn-lg">⟩</button>
    </div>

    <div class="calendar-grid">
      <div>Pn</div><div>Wt</div><div>Śr</div><div>Cz</div>
      <div>Pt</div><div>Sb</div><div>Nd</div>
    </div>

    <div class="calendar-grid" id="calendar"></div>
  </div>

  <!-- ================= GODZINY ================= -->
  <div id="hours_wrapper" style="display:none;">
    <hr>
    <h3>Dostępne godziny</h3>
    <div class="hours" id="hours"></div>
  </div>

  <!-- ================= FORMULARZ ================= -->
  <div id="form_wrapper" style="display:none;">
    <hr>
    <h3>Dane pacjenta</h3>

    <form method="post" action="/rejestracja/reserve" id="reserve_form" novalidate>
      <input type="hidden" name="visit_type" id="f_visit_type">
      <input type="hidden" name="day" id="f_day">
      <input type="hidden" name="hour" id="f_hour">
      <input type="hidden" name="payment_flow" id="payment_flow" value="reserve">
      <input type="hidden" name="payment_method" id="payment_method">

      <div class="form-group">
        <label>Imię</label>
        <input name="first_name" id="f_first_name" class="form-control input-lg">
        <div class="field-error" id="err-first">Podaj poprawne imię</div>
      </div>

      <div class="form-group">
        <label>Nazwisko</label>
        <input name="last_name" id="f_last_name" class="form-control input-lg">
        <div class="field-error" id="err-last">Podaj poprawne nazwisko</div>
      </div>

      <div class="form-group">
        <label>Telefon</label>
        <input
          name="phone"
          id="f_phone"
          class="form-control input-lg"
          value="+48"
          inputmode="tel"
        >
        <div class="field-error" id="err-phone">
          Numer w formacie +48XXXXXXXXX
        </div>
      </div>

      <div class="form-group">
        <label>Email (opcjonalnie)</label>
        <input type="email" name="email" id="f_email" class="form-control input-lg">
        <div class="field-error" id="err-email">Nieprawidłowy email</div>
      </div>
      <div class="form-group">
      <label class="terms-label">
      <input type="checkbox" id="accept_terms" required>
      Zapoznałem/-am się i akceptuję
      <a href="/static/site/files/Regulamin_swiadczenia_uslug_medycznych_IPL_Kinga_Bobinska.pdf"
        target="_blank"
        rel="noopener noreferrer">
        Regulamin świadczenia usług medycznych
      </a>
    </label>
    </div>
     <button type="submit"
        id="btn_reserve"
        class="btn btn-book btn-lg btn-block"
        disabled>
  Płatność w gabinecie
</button>

<button type="button"
        id="btn_pay"
        class="btn btn-book btn-pay btn-lg btn-block"
        disabled>
  Zapłać online (Przelewy24)
</button>

<button type="button"
        id="btn_traditional"
        class="btn btn-book btn-traditional btn-lg btn-block"
        disabled>
  Przelew tradycyjny
</button>



    </form>
  </div>

</div>

<script>
const API = "/rejestracja";

let visitTypes = {};
let availableDays = [];
let currentMonth = new Date();

const today = new Date();
today.setHours(0,0,0,0);

function resetErrors() {
  $(".has-error").removeClass("has-error");
  $(".field-error").hide();
}

function resetDaySelection() {
  $("#hours_wrapper").hide();
  $("#form_wrapper").hide();
  $("#hours").empty();
  $("#f_day").val("");
  $("#f_hour").val("");
  $(".calendar-day").removeClass("selected");
}

function validateForm(requireEmail = false) {

  resetErrors();
  $("#err-email").text("Nieprawidłowy email");
  let ok = true;

  const nameRegex = /^[A-Za-zÀ-žąćęłńóśżźĄĆĘŁŃÓŚŻŹ]+([ -][A-Za-zÀ-žąćęłńóśżźĄĆĘŁŃÓŚŻŹ]+)*$/;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const phoneRegex = /^\+[1-9]\d{1,2}\d{9,12}$/;

  if (!$("#f_visit_type").val()) ok = false;
  if (!$("#f_day").val()) ok = false;
  if (!$("#f_hour").val()) ok = false;

  const first = $("#f_first_name").val().trim();
  if (!first || !nameRegex.test(first)) {
    $("#f_first_name").addClass("has-error");
    $("#err-first").show();
    ok = false;
  }

  const last = $("#f_last_name").val().trim();
  if (!last || !nameRegex.test(last)) {
    $("#f_last_name").addClass("has-error");
    $("#err-last").show();
    ok = false;
  }

  const phone = $("#f_phone").val().trim();
  if (
    !phoneRegex.test(phone) ||
    (phone.startsWith("+48") && phone.length !== 12)
  ) {
    $("#f_phone").addClass("has-error");
    $("#err-phone").show();
    ok = false;
  }

  const email = $("#f_email").val().trim();

  if (requireEmail && !email) {
    $("#f_email").addClass("has-error");
    $("#err-email").text("Email jest wymagany przy płatności online").show();
    ok = false;
  }

  if (email && !emailRegex.test(email)) {
    $("#f_email").addClass("has-error");
    $("#err-email").text("Nieprawidłowy email").show();
    ok = false;
  }

  return ok;
}
$("#reserve_form").on("submit", function (e) {

  // jeżeli kliknięto przycisk online, nie pozwalamy na zwykły submit
  if ($("#payment_flow").val() === "online") {
    e.preventDefault();
    return false;
  }

});
/* ===== WALIDACJA FORMULARZA (DOKLEJONA) ===== */
$("#reserve_form").on("submit", function (e) {

  const ok = validateForm(false); // email opcjonalny

  if (!ok) {
    e.preventDefault();
    return false;
  }
});


/* ===== KALENDARZ ===== */
function renderCalendar() {
  const cal = $("#calendar").empty();
  const y = currentMonth.getFullYear();
  const m = currentMonth.getMonth();

  $("#calendar_title").text(
    currentMonth.toLocaleDateString("pl-PL", { month: "long", year: "numeric" })
  );

  const first = new Date(y, m, 1);
  const offset = (first.getDay() + 6) % 7;
  const daysInMonth = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < offset; i++) {
    cal.append('<div class="calendar-day disabled"></div>');
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(y, m, d);
    const dateStr =
      `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    let cls = "disabled";
    if (dateObj >= today && availableDays.includes(dateStr)) {
      cls = "available";
    }

    cal.append(`<div class="calendar-day ${cls}" data-day="${dateStr}">${d}</div>`);
  }
}

/* ===== LOAD TYPY ===== */
$(function () {
  $.getJSON(API + "/api/visit-types", function (data) {
    data.forEach(vt => {
      visitTypes[vt.code] = vt;
      $("#visit_type").append(
        `<option value="${vt.code}">${vt.name} (${vt.duration_minutes} min) – ${Number(vt.price).toFixed(2)} zł</option>`
      );
    });
  });
});

/* ===== ZMIANA TYPU ===== */
$("#visit_type").change(function () {
  const code = this.value;

  const vt = visitTypes[code];

  if (vt && vt.only_online_payment) {
    $("#btn_reserve").hide();
  } else {
    $("#btn_reserve").show();
  }


  resetDaySelection();
  $("#calendar_wrapper").hide();

  if (!code) return;

  $.getJSON(API + "/api/days", {
  visit_type: code,
  year: currentMonth.getFullYear(),
  month: currentMonth.getMonth() + 1
    }, function (days) {

    availableDays = days;
    currentMonth = new Date();
    renderCalendar();
    $("#calendar_wrapper").show();
    document.getElementById("calendar_wrapper")
      .scrollIntoView({ behavior: "smooth" });
  });
});

/* ===== NAWIGACJA ===== */
$("#next_month").click(() => {
  currentMonth.setMonth(currentMonth.getMonth() + 1);
  resetDaySelection();
  loadDaysForCurrentMonth();
});

$("#prev_month").click(() => {
  const test = new Date(currentMonth);
  test.setMonth(test.getMonth() - 1);
  if (test < new Date(today.getFullYear(), today.getMonth(), 1)) return;
  currentMonth = test;
  resetDaySelection();
  loadDaysForCurrentMonth();
});


/* ===== WYBÓR DNIA ===== */
$(document).on("click", ".calendar-day.available", function () {
  $(".calendar-day").removeClass("selected");
  $(this).addClass("selected");

  const day = $(this).data("day");
  const code = $("#visit_type").val();

  resetDaySelection();
  $("#f_day").val(day);

  $.getJSON(API + "/api/hours", { visit_type: code, day }, function (hours) {
    hours.forEach(h => {
      $("#hours").append(
        `<button type="button" class="hour-btn" data-hour="${h}">${h}</button>`
      );
    });
    $("#hours_wrapper").show();
    document.getElementById("hours_wrapper")
      .scrollIntoView({ behavior: "smooth" });
  });
});

/* ===== WYBÓR GODZINY ===== */
$(document).on("click", ".hour-btn", function () {
  $(".hour-btn").removeClass("selected");
  $(this).addClass("selected");

  $("#f_visit_type").val($("#visit_type").val());
  $("#f_hour").val($(this).data("hour"));

  $("#form_wrapper").show();
  document.getElementById("form_wrapper")
    .scrollIntoView({ behavior: "smooth" });
});

$("#accept_terms").on("change", function () {
  const enabled = this.checked;
  $("#btn_reserve").prop("disabled", !enabled);
  $("#btn_pay").prop("disabled", !enabled);
  $("#btn_traditional").prop("disabled", !enabled);
});


// ===== USTAWIENIE FLOW =====
$("#btn_reserve").on("click", function () {
  $("#payment_flow").val("reserve");
  $("#payment_method").val("");   // wyraźnie czyścimy
});

function loadDaysForCurrentMonth() {
  const code = $("#visit_type").val();
  if (!code) return;

  $.getJSON(API + "/api/days", {
    visit_type: code,
    year: currentMonth.getFullYear(),
    month: currentMonth.getMonth() + 1
  }, function (days) {
    availableDays = days;
    renderCalendar();
  });
}
$("#btn_pay").on("click", function () {

  $("#payment_flow").val("online");
  $("#payment_method").val("p24");

  const ok = validateForm(true);
  if (!ok) return;

  $("#btn_pay").prop("disabled", true);
  $("#btn_reserve").prop("disabled", true);

  const formData = $("#reserve_form").serialize();

  $.ajax({
    url: "/rejestracja/reserve?ajax=1",
    method: "POST",
    data: formData,
    dataType: "json"
  })
  .done(function (resp) {

    console.log("RESERVE RESPONSE:", resp);

    if (!resp.success || !resp.appointment_id) {
      showError(resp.error || "Błąd rezerwacji.");
      $("#btn_pay").prop("disabled", false);
      $("#btn_reserve").prop("disabled", false);
      return;
    }

    const appointmentId = resp.appointment_id;

    $.ajax({
      url: "/payments/init",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        appointment_id: appointmentId
      }),
      dataType: "json"
    })
    .done(function (p) {

      if (!p.payment_id) {
        showError("Błąd inicjalizacji płatności.");
        $("#btn_pay").prop("disabled", false);
        $("#btn_reserve").prop("disabled", false);
        return;
      }

      $.ajax({
        url: "/payments/register",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          payment_id: p.payment_id
        }),
        dataType: "json"
      })
      .done(function (r) {

        if (!r.redirect_url) {
          showError("Błąd rejestracji płatności.");
          $("#btn_pay").prop("disabled", false);
          $("#btn_reserve").prop("disabled", false);
          return;
        }

        window.location.href = r.redirect_url;
      })
      .fail(function () {
        showError("Błąd połączenia z operatorem płatności.");
        $("#btn_pay").prop("disabled", false);
        $("#btn_reserve").prop("disabled", false);
      });

    })
    .fail(function () {
      showError("Błąd inicjalizacji płatności.");
      $("#btn_pay").prop("disabled", false);
      $("#btn_reserve").prop("disabled", false);
    });

  })
  .fail(function () {
    showError("Wystąpił błąd połączenia.");
    $("#btn_pay").prop("disabled", false);
    $("#btn_reserve").prop("disabled", false);
  });

});


  $("#btn_traditional").on("click", function () {

  $("#payment_flow").val("online");
  $("#payment_method").val("traditional");

  const ok = validateForm(true);
  if (!ok) return;

  $("#btn_traditional").prop("disabled", true);
  $("#btn_pay").prop("disabled", true);
  $("#btn_reserve").prop("disabled", true);

  const formData = $("#reserve_form").serialize();

  $.ajax({
    url: "/rejestracja/reserve?ajax=1",
    method: "POST",
    data: formData,
    dataType: "json"
  }).done(function (resp) {

    if (resp.success) {

      showSuccess(resp.message);

      // reset formularza
      $("#reserve_form")[0].reset();
      $("#form_wrapper").hide();
      $("#hours_wrapper").hide();
      $("#calendar_wrapper").hide();
      $("#hours").empty();

    } else {
      showError(resp.error || "Wystąpił błąd.");
    }

  })
  .fail(function () {
    showError("Wystąpił błąd połączenia.");
  });

});



window.addEventListener("pageshow", function () {
  const nav = performance.getEntriesByType("navigation")[0];

  if (nav && nav.type === "back_forward") {
    window.location.reload();
  }
});

function showSuccess(msg) {

  const html = `
    <div class="alert alert-success">
      <button type="button" class="close js-alert-close">
        <span>&times;</span>
      </button>
      ${msg}
    </div>
  `;

  $(".page-wrapper").prepend(html);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function showError(msg) {

  const html = `
    <div class="alert alert-danger">
      <button type="button" class="close js-alert-close">
        <span>&times;</span>
      </button>
      ${msg}
    </div>
  `;

  $(".page-wrapper").prepend(html);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

</script>

</div>
{% endblock %}
