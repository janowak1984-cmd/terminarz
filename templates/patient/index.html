{% extends "patient/layout.html" %}

{% block title %}Rezerwacja wizyty{% endblock %}

{% block content %}
<div class="patient-page">

<style>
  .has-error {
    border-color: #d9534f !important;
    box-shadow: 0 0 6px rgba(217,83,79,.4);
  }

  .field-error {
    color: #d9534f;
    font-size: 13px;
    margin-top: 4px;
    display: none;
  }

  .calendar-day.disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .calendar-day.available {
    cursor: pointer;
    font-weight: bold;
  }

  .calendar-day.selected {
    background: #337ab7;
    color: #fff;
    border-radius: 4px;
  }

  /* ===== GODZINY ===== */
  .hours {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .hour-btn {
    width: calc(25% - 8px);      /* mobile: 4 */
    height: 44px;
    border: 1px solid #337ab7;
    background: #fff;
    color: #337ab7;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (min-width: 768px) {
    .hour-btn {
      width: calc(12.5% - 9px);  /* desktop: 8 */
    }
  }

  .hour-btn:hover {
    background: #eef5ff;
  }

  .hour-btn.selected {
    background: #337ab7;
    color: #fff;
  }
</style>

<div class="container-fluid">

  <h2>Rezerwacja wizyty</h2>

  <label>Rodzaj wizyty</label>
  <select id="visit_type" class="form-control">
    <option value="">-- wybierz --</option>
  </select>

  <div class="info" id="visit_info"></div>

  <!-- ================= KALENDARZ ================= -->
  <div id="calendar_wrapper" style="display:none;">
    <hr>

    <div class="calendar-header">
      <button id="prev_month" class="btn btn-default btn-lg">⟨</button>
      <strong id="calendar_title"></strong>
      <button id="next_month" class="btn btn-default btn-lg">⟩</button>
    </div>

    <div class="calendar-grid">
      <div>Pn</div><div>Wt</div><div>Śr</div><div>Cz</div>
      <div>Pt</div><div>Sb</div><div>Nd</div>
    </div>

    <div class="calendar-grid" id="calendar"></div>
  </div>

  <!-- ================= GODZINY ================= -->
  <div id="hours_wrapper" style="display:none;">
    <hr>
    <h3>Dostępne godziny</h3>
    <div class="hours" id="hours"></div>
  </div>

  <!-- ================= FORMULARZ ================= -->
  <div id="form_wrapper" style="display:none;">
    <hr>
    <h3>Dane pacjenta</h3>

    <form method="post" action="/rejestracja/reserve" id="reserve_form" novalidate>
      <input type="hidden" name="visit_type" id="f_visit_type">
      <input type="hidden" name="day" id="f_day">
      <input type="hidden" name="hour" id="f_hour">

      <div class="form-group">
        <label>Imię</label>
        <input name="first_name" id="f_first_name" class="form-control input-lg">
        <div class="field-error" id="err-first">Podaj poprawne imię</div>
      </div>

      <div class="form-group">
        <label>Nazwisko</label>
        <input name="last_name" id="f_last_name" class="form-control input-lg">
        <div class="field-error" id="err-last">Podaj poprawne nazwisko</div>
      </div>

      <div class="form-group">
        <label>Telefon</label>
        <input
          name="phone"
          id="f_phone"
          class="form-control input-lg"
          value="+48"
          inputmode="tel"
        >
        <div class="field-error" id="err-phone">
          Numer w formacie +48XXXXXXXXX
        </div>
      </div>

      <div class="form-group">
        <label>Email (opcjonalnie)</label>
        <input type="email" name="email" id="f_email" class="form-control input-lg">
        <div class="field-error" id="err-email">Nieprawidłowy email</div>
      </div>

      <button class="btn btn-primary btn-lg btn-block">
        Zarezerwuj wizytę
      </button>
    </form>
  </div>

</div>

<script>
const API = "/rejestracja";

let visitTypes = {};
let availableDays = [];
let currentMonth = new Date();

const today = new Date();
today.setHours(0,0,0,0);

function resetErrors() {
  $(".has-error").removeClass("has-error");
  $(".field-error").hide();
}

function resetDaySelection() {
  $("#hours_wrapper").hide();
  $("#form_wrapper").hide();
  $("#hours").empty();
  $("#f_day").val("");
  $("#f_hour").val("");
  $(".calendar-day").removeClass("selected");
}

/* ===== WALIDACJA FORMULARZA (DOKLEJONA) ===== */
$("#reserve_form").on("submit", function (e) {
  resetErrors();
  let ok = true;

  const nameRegex = /^[A-Za-zÀ-žąćęłńóśżźĄĆĘŁŃÓŚŻŹ]+([ -][A-Za-zÀ-žąćęłńóśżźĄĆĘŁŃÓŚŻŹ]+)*$/;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const phoneRegex = /^\+[1-9]\d{1,2}\d{9,12}$/;

  if (!$("#f_visit_type").val()) ok = false;
  if (!$("#f_day").val()) ok = false;
  if (!$("#f_hour").val()) ok = false;

  const first = $("#f_first_name").val().trim();
  if (!first || !nameRegex.test(first)) {
    $("#f_first_name").addClass("has-error");
    $("#err-first").show();
    ok = false;
  }

  const last = $("#f_last_name").val().trim();
  if (!last || !nameRegex.test(last)) {
    $("#f_last_name").addClass("has-error");
    $("#err-last").show();
    ok = false;
  }

  const phone = $("#f_phone").val().trim();
  if (
    !phoneRegex.test(phone) ||
    (phone.startsWith("+48") && phone.length !== 12)
  ) {
    $("#f_phone").addClass("has-error");
    $("#err-phone").show();
    ok = false;
  }

  const email = $("#f_email").val().trim();
  if (email && !emailRegex.test(email)) {
    $("#f_email").addClass("has-error");
    $("#err-email").show();
    ok = false;
  }

  if (!ok) {
    e.preventDefault();
    return false;
  }
});

/* ===== KALENDARZ ===== */
function renderCalendar() {
  const cal = $("#calendar").empty();
  const y = currentMonth.getFullYear();
  const m = currentMonth.getMonth();

  $("#calendar_title").text(
    currentMonth.toLocaleDateString("pl-PL", { month: "long", year: "numeric" })
  );

  const first = new Date(y, m, 1);
  const offset = (first.getDay() + 6) % 7;
  const daysInMonth = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < offset; i++) {
    cal.append('<div class="calendar-day disabled"></div>');
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(y, m, d);
    const dateStr =
      `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    let cls = "disabled";
    if (dateObj >= today && availableDays.includes(dateStr)) {
      cls = "available";
    }

    cal.append(`<div class="calendar-day ${cls}" data-day="${dateStr}">${d}</div>`);
  }
}

/* ===== LOAD TYPY ===== */
$(function () {
  $.getJSON(API + "/api/visit-types", function (data) {
    data.forEach(vt => {
      visitTypes[vt.code] = vt;
      $("#visit_type").append(
        `<option value="${vt.code}">${vt.name} (${vt.duration_minutes} min) – ${Number(vt.price).toFixed(2)} zł</option>`
      );
    });
  });
});

/* ===== ZMIANA TYPU ===== */
$("#visit_type").change(function () {
  const code = this.value;
  resetDaySelection();
  $("#calendar_wrapper").hide();

  if (!code) return;

  $.getJSON(API + "/api/days", { visit_type: code }, function (days) {
    availableDays = days;
    currentMonth = new Date();
    renderCalendar();
    $("#calendar_wrapper").show();
    document.getElementById("calendar_wrapper")
      .scrollIntoView({ behavior: "smooth" });
  });
});

/* ===== NAWIGACJA ===== */
$("#next_month").click(() => {
  currentMonth.setMonth(currentMonth.getMonth() + 1);
  resetDaySelection();
  renderCalendar();
});

$("#prev_month").click(() => {
  const test = new Date(currentMonth);
  test.setMonth(test.getMonth() - 1);
  if (test < new Date(today.getFullYear(), today.getMonth(), 1)) return;
  currentMonth = test;
  resetDaySelection();
  renderCalendar();
});

/* ===== WYBÓR DNIA ===== */
$(document).on("click", ".calendar-day.available", function () {
  $(".calendar-day").removeClass("selected");
  $(this).addClass("selected");

  const day = $(this).data("day");
  const code = $("#visit_type").val();

  resetDaySelection();
  $("#f_day").val(day);

  $.getJSON(API + "/api/hours", { visit_type: code, day }, function (hours) {
    hours.forEach(h => {
      $("#hours").append(
        `<button type="button" class="hour-btn" data-hour="${h}">${h}</button>`
      );
    });
    $("#hours_wrapper").show();
    document.getElementById("hours_wrapper")
      .scrollIntoView({ behavior: "smooth" });
  });
});

/* ===== WYBÓR GODZINY ===== */
$(document).on("click", ".hour-btn", function () {
  $(".hour-btn").removeClass("selected");
  $(this).addClass("selected");

  $("#f_visit_type").val($("#visit_type").val());
  $("#f_hour").val($(this).data("hour"));

  $("#form_wrapper").show();
  document.getElementById("form_wrapper")
    .scrollIntoView({ behavior: "smooth" });
});
</script>

</div>
{% endblock %}
